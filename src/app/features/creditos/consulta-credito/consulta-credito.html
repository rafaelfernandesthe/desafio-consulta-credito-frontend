<div class="container">
  <mat-card class="consulta-card">
    <mat-card-header>
      <mat-card-title>Consulta de Créditos Constituídos</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="consultaForm" (ngSubmit)="consultar()">
        <div class="form-content">
          <mat-radio-group formControlName="tipoBusca" class="radio-group">
            <mat-radio-button value="nfse">Número da NFS-e</mat-radio-button>
            <mat-radio-button value="credito">Número do Crédito</mat-radio-button>
          </mat-radio-group>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>
              {{ consultaForm.value.tipoBusca === TP_BUSCA_NFSE ? 'Número da NFS-e' : 'Número do Crédito' }}
            </mat-label>
            <input
              matInput
              formControlName="numeroConsulta"
              placeholder="Digite o número para consulta"
            />
            @if (consultaForm.get('numeroConsulta')?.hasError('required')) {
              <mat-error>Este campo é obrigatório</mat-error>
            }
          </mat-form-field>

          <div class="button-group">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
              @if (!loading()) {
                <span>Consultar</span>
              }
              @if (loading()) {
                <span>Consultando...</span>
              }
            </button>
            <button mat-raised-button type="button" (click)="limpar()" [disabled]="loading()">
              Limpar
            </button>
          </div>
        </div>
      </form>

      @if (loading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      }

      @if (creditos().length > 0 && !loading()) {
        <div class="resultados">
          <h3>Resultados da Consulta</h3>
          <div class="table-container">
            @if (creditos().length == 0) {
              <table class="creditos-table">
                <span>Não foram encontrados resultados para a consulta.</span>
              </table>
            }
            <table mat-table [dataSource]="creditos()" class="creditos-table">
              <!-- Coluna Número do Crédito -->
              <ng-container matColumnDef="numeroCredito">
                <th mat-header-cell *matHeaderCellDef>Nº Crédito</th>
                <td mat-cell *matCellDef="let credito">{{ credito.numeroCredito }}</td>
              </ng-container>

              <!-- Coluna Número da NFS-e -->
              <ng-container matColumnDef="numeroNfse">
                <th mat-header-cell *matHeaderCellDef>Nº NFS-e</th>
                <td mat-cell *matCellDef="let credito">{{ credito.numeroNfse }}</td>
              </ng-container>

              <!-- Coluna Data de Constituição -->
              <ng-container matColumnDef="dataConstituicao">
                <th mat-header-cell *matHeaderCellDef>Data Constituição</th>
                <td mat-cell *matCellDef="let credito">{{ formatarData(credito.dataConstituicao) }}</td>
              </ng-container>

              <!-- Coluna Valor ISSQN -->
              <ng-container matColumnDef="valorIssqn">
                <th mat-header-cell *matHeaderCellDef>Valor ISSQN</th>
                <td mat-cell *matCellDef="let credito">{{ formatarMoeda(credito.valorIssqn) }}</td>
              </ng-container>

              <!-- Coluna Tipo de Crédito -->
              <ng-container matColumnDef="tipoCredito">
                <th mat-header-cell *matHeaderCellDef>Tipo Crédito</th>
                <td mat-cell *matCellDef="let credito">{{ credito.tipoCredito }}</td>
              </ng-container>

              <!-- Coluna Simples Nacional -->
              <ng-container matColumnDef="simplesNacional">
                <th mat-header-cell *matHeaderCellDef>Simples Nacional</th>
                <td mat-cell *matCellDef="let credito">{{ credito.simplesNacional }}</td>
              </ng-container>

              <!-- Coluna Alíquota -->
              <ng-container matColumnDef="aliquota">
                <th mat-header-cell *matHeaderCellDef>Alíquota</th>
                <td mat-cell *matCellDef="let credito">{{ formatarPorcentagem(credito.aliquota) }}</td>
              </ng-container>

              <!-- Coluna Valor Faturado -->
              <ng-container matColumnDef="valorFaturado">
                <th mat-header-cell *matHeaderCellDef>Valor Faturado</th>
                <td mat-cell *matCellDef="let credito">{{ formatarMoeda(credito.valorFaturado) }}</td>
              </ng-container>

              <!-- Coluna Valor Dedução -->
              <ng-container matColumnDef="valorDeducao">
                <th mat-header-cell *matHeaderCellDef>Valor Dedução</th>
                <td mat-cell *matCellDef="let credito">{{ formatarMoeda(credito.valorDeducao) }}</td>
              </ng-container>

              <!-- Coluna Base de Cálculo -->
              <ng-container matColumnDef="baseCalculo">
                <th mat-header-cell *matHeaderCellDef>Base Cálculo</th>
                <td mat-cell *matCellDef="let credito">{{ formatarMoeda(credito.baseCalculo) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>

          <!-- Versão Mobile com Cards -->
          <div class="mobile-cards">
            @for (credito of creditos(); track credito.numeroCredito) {
              <mat-card class="credito-card">
                <mat-card-content>
                  <div class="credito-info">
                    <div class="info-row">
                      <span class="label">Nº Crédito:</span>
                      <span class="value">{{ credito.numeroCredito }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Nº NFS-e:</span>
                      <span class="value">{{ credito.numeroNfse }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Data Constituição:</span>
                      <span class="value">{{ formatarData(credito.dataConstituicao) }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Valor ISSQN:</span>
                      <span class="value destaque">{{ formatarMoeda(credito.valorIssqn) }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Tipo Crédito:</span>
                      <span class="value">{{ credito.tipoCredito }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Simples Nacional:</span>
                      <span class="value">{{ credito.simplesNacional }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Alíquota:</span>
                      <span class="value">{{ formatarPorcentagem(credito.aliquota) }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Valor Faturado:</span>
                      <span class="value">{{ formatarMoeda(credito.valorFaturado) }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Valor Dedução:</span>
                      <span class="value">{{ formatarMoeda(credito.valorDeducao) }}</span>
                    </div>
                    <div class="info-row">
                      <span class="label">Base Cálculo:</span>
                      <span class="value">{{ formatarMoeda(credito.baseCalculo) }}</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            }
          </div>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
